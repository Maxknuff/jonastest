---
// 1. CSS und Funktionen laden
import '../../styles.css'; 
import { products as fallbackProducts } from '../../products.js';
import { ArrowLeft, ShieldCheck, Truck } from 'lucide-react';

// 2. Komponenten importieren
import Header from '../../components/Header.jsx';
import CheckoutOverlay from '../../components/CheckoutOverlay.jsx';
import SupportOverlay from '../../components/SupportOverlay.jsx';
import AddToCartButton from '../../components/AddToCartButton.jsx';

// WICHTIG: getStaticPaths wurde ENTFERNT! Vercel generiert die Seite jetzt live.

// 3. ID aus der URL holen
const { id } = Astro.params;

let product = null;

// 4. API URL bestimmen
// Auf Vercel ist import.meta.env.DEV false, also nutzen wir die Render-URL
const API_URL = import.meta.env.DEV 
  ? 'http://localhost:5000' 
  : 'https://jonastest.onrender.com';

// 5. Versuch: Produkt live von Render laden
try {
  // Timeout von 4 Sekunden, falls Render schläft
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 4000); 

  const res = await fetch(`${API_URL}/api/products/${id}`, { signal: controller.signal });
  clearTimeout(timeoutId);

  if (res.ok) {
    product = await res.json();
  }
} catch (err) {
  console.error("API Fehler (Render könnte schlafen):", err);
}

// 6. Fallback: Wenn Render nicht antwortet, suche in der statischen Datei
if (!product) {
  product = fallbackProducts.find(p => p.id === id);
}

// 7. Wenn immer noch nichts gefunden -> 404 Seite
if (!product) {
  return Astro.redirect('/404');
}
---

<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{product.name} | SECURE.</title>
  </head>
  <body class="bg-[#F5F5F7] text-[#1D1D1F]">
    
    <Header client:only="react" />

    <main class="pt-32 pb-20 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <a href="/" class="inline-flex items-center gap-2 text-gray-500 hover:text-black mb-8 transition-colors font-medium">
        <ArrowLeft size={20} /> Zurück zum Shop
      </a>

      <div class="bg-white rounded-[30px] p-8 md:p-12 shadow-sm border border-gray-100">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 lg:gap-20 items-center">
      
          <div class="relative bg-gray-50 rounded-2xl p-8 flex items-center justify-center aspect-square group overflow-hidden">
             <img 
               src={product.image || '/products/VAPE12K.png'} 
               alt={product.name} 
               class="w-full h-full object-contain object-center group-hover:scale-105 transition-transform duration-500 drop-shadow-xl"
             />
          </div>

          <div>
            <span class="text-[#0071E3] font-bold tracking-wide uppercase text-xs mb-2 block">Premium Hardware</span>
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-4 text-[#1D1D1F]">{product.name}</h1>
            
            <div class="text-3xl font-medium text-[#1D1D1F] mb-8">
               {Number(product.price).toFixed(2)}€
            </div>

            <p class="text-gray-500 text-lg leading-relaxed mb-8 border-b border-gray-100 pb-8">
              {product.description || "Keine Beschreibung verfügbar."}
            </p>

            <div class="space-y-3 mb-8">
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <ShieldCheck className="text-[#0071E3]" size={20} /> 
                <span>24 Monate Garantie & Support</span>
              </div>
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <Truck className="text-[#0071E3]" size={20} /> 
                <span>Diskreter Versand (2-3 Werktage)</span>
              </div>
            </div>

            {/* Der Button prüft live den Bestand */}
            <AddToCartButton client:only="react" product={product} />
          </div>

        </div>
      </div>

    </main>

    <CheckoutOverlay client:only="react" />
    <SupportOverlay client:only="react" />

  </body>
</html>